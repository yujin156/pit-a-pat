<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Friend</title>

    <link rel="stylesheet" th:href="@{/css/Content.css}">
    <link rel="stylesheet" th:href="@{/css/Friend.css}">
    <link rel="stylesheet" th:href="@{/css/Side_menu.css}">
    <link rel="stylesheet" th:href="@{/css/Login_center.css}">
</head>
<body>
<div class="layout-container">
    <div class="side-menu" th:insert="~{Side_menu :: sidebar}" ></div>
    <div class="friend_wrap">
        <h2 class="friend_title">Friend</h2>

        <!-- âœ… í”„ë¡œí•„ ì„ íƒ ë“œë¡­ë‹¤ìš´ (ë¡œê·¸ì¸ + ê°•ì•„ì§€ 2ë§ˆë¦¬ ì´ìƒì¼ ë•Œë§Œ í‘œì‹œ) -->
        <div class="friend_profile_selector"
             th:if="${isLoggedIn != null and isLoggedIn and showProfileSelector != null and showProfileSelector}"
             sec:authorize="isAuthenticated()">
            <label for="friendDogSelect">ë‚´ ê°•ì•„ì§€ ì„ íƒ:</label>
            <select id="friendDogSelect" class="friend-profile-select">
                <option value="">ì–´ë–¤ ê°•ì•„ì§€ì˜ ì¹œêµ¬ë¥¼ ë³¼ê¹Œìš”?</option>
                <option th:each="dog : ${userDogs}"
                        th:if="${dog != null and dog.dno != null and dog.dname != null}"
                        th:value="${dog.dno}"
                        th:selected="${dog.dno == selectedDogId}"
                        th:text="${dog.dname + (dog.speciesName != null ? ' (' + dog.speciesName + ')' : '')}"></option>
            </select>
        </div>

        <p class="friend_sub_title">ì¢‹ì•„í•˜ëŠ” ê°•ì•„ì§€ ì¹œêµ¬ë“¤</p>

        <!--    ê°•ì•„ì§€ ê²€ìƒ‰  -->
        <div class="friend_input">
            <input type="search" class="search_type" placeholder="ê²¬ì¢… ê²€ìƒ‰í•˜ê¸°">
            <input type="search" class="search_friend" placeholder="ê°•ì•„ì§€ ì¹œêµ¬ ê²€ìƒ‰í•˜ê¸°">
        </div>

        <div class="friend_content">
            <!-- âœ… ì¹œêµ¬ê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ -->
            <div th:if="${friends == null or #lists.isEmpty(friends)}" class="no-friends-message">
                <div class="no-friends-icon">ğŸ•</div>
                <h3>ì•„ì§ ì¹œêµ¬ê°€ ì—†ì–´ìš”</h3>
                <p>ë§¤ì¹­ í˜ì´ì§€ì—ì„œ ìƒˆë¡œìš´ ì¹œêµ¬ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
                <button onclick="window.location.href='/matching'" class="goto-matching-btn">ë§¤ì¹­í•˜ëŸ¬ ê°€ê¸°</button>
            </div>

            <!-- âœ… ì¹œêµ¬ ëª©ë¡ í‘œì‹œ -->
            <div th:if="${friends != null and !#lists.isEmpty(friends)}" class="dog-grid-container">
                <div th:each="friend : ${friends}" class="friend_dog_card" th:data-dog-id="${friend.dno}">
                    <div class="f_dog_hbtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="5" height="25" viewBox="0 0 5 25">
                            <g id="ê·¸ë£¹_162482" data-name="ê·¸ë£¹ 162482" transform="translate(-7432 -1784)">
                                <circle cx="2.5" cy="2.5" r="2.5" transform="translate(7432 1784)" fill="#b7b7b7"/>
                                <circle cx="2.5" cy="2.5" r="2.5" transform="translate(7432 1794)" fill="#b7b7b7"/>
                                <circle cx="2.5" cy="2.5" r="2.5" transform="translate(7432 1804)" fill="#b7b7b7"/>
                            </g>
                        </svg>
                    </div>
                    <div class="f_dog_card_cont">
                        <!-- âœ… ì¹œêµ¬ ì´ë¯¸ì§€ ì²˜ë¦¬ ê°œì„  -->
                        <div th:if="${friend.image != null and friend.image.diurl != null and !#strings.isEmpty(friend.image.diurl)}">
                            <img class="f_dog_img"
                                 th:src="@{${friend.image.diurl}}"
                                 th:alt="|${friend.dname} ì‚¬ì§„|"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                            <div class="f_dog_img default-img" style="display: none; background: linear-gradient(135deg, #387FEB, #6FA4FF); display: flex; align-items: center; justify-content: center; font-size: 60px; color: white; font-weight: bold;"
                                 th:text="${!#strings.isEmpty(friend.dname) ? #strings.substring(friend.dname, 0, 1) : 'ğŸ•'}">ğŸ•</div>
                        </div>

                        <div th:if="${friend.image == null or friend.image.diurl == null or #strings.isEmpty(friend.image.diurl)}"
                             class="f_dog_img default-img"
                             style="background: linear-gradient(135deg, #387FEB, #6FA4FF); display: flex; align-items: center; justify-content: center; font-size: 60px; color: white; font-weight: bold;"
                             th:text="${!#strings.isEmpty(friend.dname) ? #strings.substring(friend.dname, 0, 1) : 'ğŸ•'}">ğŸ•</div>

                        <!-- âœ… ì¹œêµ¬ ì´ë¦„ -->
                        <p class="f_dog_name" th:text="${friend.dname != null ? friend.dname : 'ì´ë¦„ ë¯¸ê³µê°œ'}">ì´ë¦„</p>

                        <!-- âœ… ì¹œêµ¬ ì •ë³´ í‚¤ì›Œë“œ -->
                        <div class="dog_keyword_row">
                            <!-- ì£¼ì†Œ ì •ë³´ -->
                            <label class="dog_keyword"
                                   th:text="${friendAddressMap != null and friendAddressMap[friend.dno] != null ? friendAddressMap[friend.dno] : 'ìœ„ì¹˜ ë¯¸ê³µê°œ'}">
                                ìœ„ì¹˜ ë¯¸ê³µê°œ
                            </label>

                            <!-- ì„±ë³„ ì •ë³´ -->
                            <label class="dog_keyword"
                                   th:text="${friend.ugender != null ? friend.ugender.Doglabel() : 'ì„±ë³„ ë¯¸ê³µê°œ'}">
                                ì„±ë³„ ë¯¸ê³µê°œ
                            </label>

                            <!-- ê²¬ì¢… ì •ë³´ -->
                            <label class="dog_keyword"
                                   th:text="${friend.species != null and friend.species.name != null ? friend.species.name : 'ê²¬ì¢… ë¯¸ê³µê°œ'}">
                                ê²¬ì¢… ë¯¸ê³µê°œ
                            </label>
                        </div>

                        <!-- âœ… ì¹œêµ¬ ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
                        <div class="friend_actions">
                            <button class="friend_action_btn profile_btn"
                                    th:data-dog-id="${friend.dno}"
                                    title="í”„ë¡œí•„ ë³´ê¸°">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                            </button>

                            <!-- âœ… ì±„íŒ… ë²„íŠ¼ ê°œì„  -->
                            <button class="friend_action_btn chat_btn"
                                    th:data-friend-request-id="${friendRequestIds != null and friendRequestIds[friend.dno] != null ? friendRequestIds[friend.dno] : ''}"
                                    th:classappend="${friendRequestIds == null or friendRequestIds[friend.dno] == null} ? 'disabled' : ''"
                                    th:disabled="${friendRequestIds == null or friendRequestIds[friend.dno] == null}"
                                    th:title="${friendRequestIds != null and friendRequestIds[friend.dno] != null ? 'ì±„íŒ…í•˜ê¸°' : 'ì±„íŒ… ë¶ˆê°€ëŠ¥'}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="login-panel" th:insert="~{Login_center :: login }" ></div>
</div>

<!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
<div class="loading-spinner hidden" id="friendLoadingSpinner">
    <div class="spinner"></div>
    <p>ì¹œêµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<!-- ì•Œë¦¼ í† ìŠ¤íŠ¸ -->
<div class="friend-notification" id="friendNotification"></div>

<!-- âœ… ë””ë²„ê¹… ì •ë³´ ì¶”ê°€ -->
<script th:inline="javascript">
    console.log('=== Friend.html ë°ì´í„° ë¡œë“œ ì‹œì‘ ===');

    // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„°
    const rawUserDogs = /*[[${userDogs}]]*/ [];
    const rawIsLoggedIn = /*[[${isLoggedIn}]]*/ false;
    const rawShowProfileSelector = /*[[${showProfileSelector}]]*/ false;
    const rawSelectedDogId = /*[[${selectedDogId}]]*/ null;
    const rawFriends = /*[[${friends}]]*/ [];
    const rawFriendAddressMap = /*[[${friendAddressMap}]]*/ {};
    const rawFriendRequestIds = /*[[${friendRequestIds}]]*/ {};

    console.log('Raw ë°ì´í„° í™•ì¸:');
    console.log('- userDogs:', rawUserDogs);
    console.log('- isLoggedIn:', rawIsLoggedIn);
    console.log('- showProfileSelector:', rawShowProfileSelector);
    console.log('- selectedDogId:', rawSelectedDogId);
    console.log('- friends:', rawFriends);
    console.log('- friendAddressMap:', rawFriendAddressMap);
    console.log('- friendRequestIds:', rawFriendRequestIds);

    // âœ… ì¹œêµ¬ ë°ì´í„° ìƒì„¸ ë¡œê·¸
    if (rawFriends && rawFriends.length > 0) {
        console.log('ì¹œêµ¬ ë°ì´í„° ìƒì„¸:');
        rawFriends.forEach((friend, index) => {
            console.log(`ì¹œêµ¬ ${index + 1}:`, {
                id: friend.dno,
                name: friend.dname,
                gender: friend.ugender,
                species: friend.species,
                image: friend.image,
                addressInMap: rawFriendAddressMap[friend.dno],
                requestIdInMap: rawFriendRequestIds[friend.dno]
            });
        });
    }

    // ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
    window.friendData = {
        userDogs: Array.isArray(rawUserDogs) ? rawUserDogs : [],
        isLoggedIn: Boolean(rawIsLoggedIn),
        showProfileSelector: Boolean(rawShowProfileSelector),
        selectedDogId: rawSelectedDogId,
        friends: Array.isArray(rawFriends) ? rawFriends : [],
        friendAddressMap: rawFriendAddressMap || {},
        friendRequestIds: rawFriendRequestIds || {}
    };

    console.log('ìµœì¢… friendData:', window.friendData);
    console.log('=== Friend.html ë°ì´í„° ë¡œë“œ ì™„ë£Œ ===');
</script>

<script defer th:src="@{/js/Friend.js}"></script>
<script th:src="@{/js/Side_menu.js}"></script>
<script th:src="@{/js/Login_center.js}"></script>
</body>
</html>
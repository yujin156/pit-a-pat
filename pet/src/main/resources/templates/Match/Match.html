<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MATCH - ìš°ë¦¬ì§‘ ê°•ì•„ì§€ ì¹œêµ¬ ë§Œë“¤ì–´ì£¼ê¸°</title>
  <link rel="stylesheet" th:href="@{/css/Content.css}">
  <link rel="stylesheet" th:href="@{/css/Match.css}">
  <link rel="stylesheet" th:href="@{/css/Match_profile.css}">
  <link rel="stylesheet" th:href="@{/css/Side_menu.css}">
  <link rel="stylesheet" th:href="@{/css/Login_center.css}">
</head>
<body>

<div class="layout-container">
  <!-- Sidebar -->
  <div class="side-menu" th:insert="~{Side_menu :: sidebar}"></div>

  <!-- Main Content -->
  <div class="main_content">
    <!-- Page Header -->
    <div class="match-header">
      <h1>MATCH</h1>
      <p>ìš°ë¦¬ì§‘ ê°•ì•„ì§€ ì¹œêµ¬ ë§Œë“¤ì–´ì£¼ê¸°</p>
    </div>

    <!-- 1. í”„ë¡œí•„ ì„ íƒ (ë¡œê·¸ì¸ + ê°•ì•„ì§€ 2ë§ˆë¦¬ ì´ìƒì¼ ë•Œë§Œ) -->
    <div class="profile-selector"
         th:if="${isLoggedIn != null and isLoggedIn and showProfileSelector != null and showProfileSelector}"
         sec:authorize="isAuthenticated()">
      <label for="myDogSelect">ë‚´ í”„ë¡œí•„ ì„ íƒ:</label>
      <select id="myDogSelect" class="profile-select">
        <option value="">ì–´ë–¤ ê°•ì•„ì§€ë¡œ ë§¤ì¹­í• ê¹Œìš”?</option>
        <option th:each="dog : ${userDogs}"
                th:if="${dog != null and dog.dno != null and dog.dname != null}"
                th:value="${dog.dno}"
                th:text="${dog.dname + (dog.speciesName != null ? ' (' + dog.speciesName + ')' : '')}"></option>
      </select>
    </div>

    <!-- 2. ìƒì„¸ê²€ìƒ‰ê³¼ í‚¤ì›Œë“œ ì„ íƒ -->
    <div class="filter-and-keyword-section">
      <!-- ê²€ìƒ‰ í•„í„° ì˜ì—­ (ì™¼ìª½) -->
      <div class="search-filter-section">
        <h2>ìƒì„¸ ê²€ìƒ‰</h2>
        <div class="filter-row">
          <select id="genderFilter" class="filter-select">
            <option value="">ì„±ë³„</option>
            <option value="ìˆ˜ì»·">ìˆ˜ì»·</option>
            <option value="ì•”ì»·">ì•”ì»·</option>
          </select>

          <input type="text" id="breedFilter" class="filter-input" placeholder="ê²¬ì¢… ê²€ìƒ‰">
          <input type="text" id="locationFilter" class="filter-input" placeholder="ì§€ì—­ ê²€ìƒ‰">
        </div>
        <div class="filter-actions">
          <button id="searchBtn" class="filter-btn primary">ê²€ìƒ‰</button>
          <button id="resetBtn" class="filter-btn secondary">ì´ˆê¸°í™”</button>
        </div>
      </div>

      <!-- í‚¤ì›Œë“œ ì„ íƒ ì˜ì—­ (ì˜¤ë¥¸ìª½) -->
      <div class="keyword-section">
        <h2>ê´€ì‹¬ í‚¤ì›Œë“œ ì„ íƒ</h2>
        <p class="keyword-info">
          ì„ íƒëœ í‚¤ì›Œë“œ: <span id="selectedCount">0</span>ê°œ
          <span th:if="${isLoggedIn == null or !isLoggedIn}"> (ë¹„íšŒì›ì€ ìµœëŒ€ 2ê°œ)</span>
          <span th:if="${isLoggedIn != null and isLoggedIn}"> (íšŒì›ì€ ë¬´ì œí•œ)</span>
        </p>

        <!-- í‚¤ì›Œë“œ ê·¸ë¦¬ë“œ -->
        <div class="keyword-grid">
          <button class="keyword-btn"
                  th:each="keyword : ${keywords}"
                  th:if="${keyword != null and keyword.dktag != null}"
                  th:data-keyword="${keyword.dktag}"
                  th:text="${keyword.dktag}">í‚¤ì›Œë“œ</button>
        </div>

        <!-- í‚¤ì›Œë“œ ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="keyword-actions">
          <button id="showAllBtn" class="action-btn secondary">ì „ì²´ ë³´ê¸°</button>
        </div>
      </div>
    </div>

    <!-- 3. ë§¤ì¹­ ì˜ì—­ (ì¹´ë“œ ìŠ¤íƒë§Œ) -->
    <div class="matching-section">
      <div class="card-stack-container">
        <div class="card-stack" id="cardStack">
          <!-- ê°•ì•„ì§€ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>
      </div>

      <!-- ìŠ¤ì™€ì´í”„ ì•ˆë‚´ í…ìŠ¤íŠ¸ -->
      <div class="swipe-instructions">
        <p>ğŸ’¡ ì¹´ë“œë¥¼ ì¢Œìš°ë¡œ ë“œë˜ê·¸í•˜ê±°ë‚˜ í‚¤ë³´ë“œ í™”ì‚´í‘œí‚¤ë¡œ ë‹¤ìŒ í”„ë¡œí•„ì„ ë³¼ ìˆ˜ ìˆì–´ìš”!</p>
      </div>
    </div>

    <!-- ë§¤ì¹­ ì„±ì‚¬ ëª¨ë‹¬ -->
    <div class="match-modal" id="matchModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">ë§¤ì¹­ ì„±ì‚¬! ğŸ‰</h3>
        </div>
        <div class="matched-dogs">
          <div class="my-dog">
            <img id="myDogImage" src="" alt="ë‚´ ê°•ì•„ì§€">
            <p id="myDogName">ë‚´ ê°•ì•„ì§€</p>
          </div>
          <div class="heart-animation">ğŸ’–</div>
          <div class="friend-dog">
            <img id="friendDogImage" src="" alt="ì¹œêµ¬ ê°•ì•„ì§€">
            <p id="friendDogName">ì¹œêµ¬ ê°•ì•„ì§€</p>
          </div>
        </div>
        <p id="modalMessage">ìƒˆë¡œìš´ ì¹œêµ¬ê°€ ë˜ì—ˆì–´ìš”!</p>
        <div class="modal-actions">
          <button id="continueBtn" class="modal-btn secondary">ê³„ì† ë§¤ì¹­í•˜ê¸°</button>
          <button id="chatBtn" class="modal-btn primary">ì¹œêµ¬ ëª©ë¡ìœ¼ë¡œ</button>
        </div>
      </div>
    </div>

    <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div class="loading-spinner hidden" id="loadingSpinner">
      <div class="spinner"></div>
      <p>ë§¤ì¹­ ì¤‘...</p>
    </div>
  </div>

  <!-- Login Panel -->
  <div class="login-panel" th:insert="~{Login_center :: login}"></div>
</div>
<!-- ê¸°ì¡´ ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ë‘ê³ , JavaScript ë¶€ë¶„ë§Œ ìˆ˜ì • -->
<script th:inline="javascript">
  console.log('=== Match.html ë°ì´í„° ë¡œë“œ ì‹œì‘ ===');

  // âœ… matchingDogsë¡œ ë³€ìˆ˜ëª… ë³€ê²½í•˜ì—¬ ë°›ê¸°
  const rawMatchingDogs = /*[[${matchingDogs}]]*/ [];
  const rawUserDogs = /*[[${userDogs}]]*/ [];
  const rawKeywords = /*[[${keywords}]]*/ [];
  const rawIsLoggedIn = /*[[${isLoggedIn}]]*/ false;
  const rawShowProfileSelector = /*[[${showProfileSelector}]]*/ false;

  console.log('Raw ë°ì´í„° í™•ì¸:');
  console.log('- matchingDogs:', rawMatchingDogs);
  console.log('- userDogs:', rawUserDogs);
  console.log('- keywords:', rawKeywords);
  console.log('- isLoggedIn:', rawIsLoggedIn);
  console.log('- showProfileSelector:', rawShowProfileSelector);

  // âœ… matchingDogsë¥¼ dogsë¡œ ë§¤í•‘í•˜ì—¬ ê¸°ì¡´ JavaScript ì½”ë“œì™€ í˜¸í™˜
  window.matchData = {
    dogs: Array.isArray(rawMatchingDogs) ? rawMatchingDogs : [], // matchingDogsë¥¼ dogsë¡œ ë§¤í•‘
    userDogs: Array.isArray(rawUserDogs) ? rawUserDogs : [],
    keywords: Array.isArray(rawKeywords) ? rawKeywords : [],
    isLoggedIn: Boolean(rawIsLoggedIn),
    showProfileSelector: Boolean(rawShowProfileSelector)
  };

  console.log('ìµœì¢… matchData:', window.matchData);
  console.log('ë§¤ì¹­ìš© ê°•ì•„ì§€ ìˆ˜:', window.matchData.dogs.length);
  console.log('ë‚´ ê°•ì•„ì§€ ìˆ˜:', window.matchData.userDogs.length);
  console.log('í‚¤ì›Œë“œ ìˆ˜:', window.matchData.keywords.length);
  console.log('=== Match.html ë°ì´í„° ë¡œë“œ ì™„ë£Œ ===');
</script>

<script th:src="@{/js/MatchJS/Match.js}"></script>
<script th:src="@{/js/MatchJS/Match_profile.js}"></script>
<script th:src="@{/js/Side_menu.js}"></script>
<script th:src="@{/js/Login_center.js}"></script>
</body>
</html>